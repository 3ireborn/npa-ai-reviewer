<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NPA AI Reviewer</title>

  <!-- Link ke style.css -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <div class="inner">

        <!-- HEADER -->
        <div class="header">
          <div class="logo">NPA</div>
          <div class="title">
            <h1>NPA AI Reviewer</h1>
            <div class="subtitle">Generate Caption Â· Komentar Â· Meta-Friendly</div>
          </div>
        </div>

        <!------------ MAIN GRID ------------->
        <div class="grid">

          <!-- LEFT: FORM PANEL -->
          <div class="panel">

            <!-- Upload -->
            <label>Upload Gambar (opsional)</label>
            <input id="imageInput" type="file" accept="image/*" />
            <div id="preview" class="preview"></div>

            <!-- Nama produk -->
            <label>Nama Produk / Judul</label>
            <input id="name" type="text" placeholder="Contoh: Semangat Bangkit" />

            <!-- Preset -->
            <label>Preset Tema</label>
            <select id="preset">
              <option value="">â€” Pilih Preset â€”</option>
              <option>Story-Selling UMKM</option>
              <option>Motivasi Harian</option>
              <option>Bisnis & Income</option>
              <option>Islami / Spiritual</option>
              <option>Parenting / Keluarga</option>
              <option>Edukasi / Tips</option>
              <option>Perjalanan Hidup</option>
              <option>Konten Harian</option>
              <option>Soft Selling</option>
              <option>Personal Branding</option>
            </select>

            <!-- Manual name -->
            <label>Nama Manual (opsional)</label>
            <input id="nameManual" type="text" placeholder="Sesuaikan sendiri" />

            <!-- Type & tone -->
            <div class="grid-2">
              <div>
                <label>Tipe Konten</label>
                <select id="type">
                  <option>Campuran</option>
                  <option>Motivasi</option>
                  <option>UMKM</option>
                  <option>Personal</option>
                  <option>Review Produk</option>
                </select>
              </div>
              <div>
                <label>Gaya Narasi</label>
                <select id="tone">
                  <option>Inspiratif</option>
                  <option>Santai</option>
                  <option>Profesional</option>
                  <option>Friendly</option>
                </select>
              </div>
            </div>

            <!-- Referral -->
            <label>Link Referral (opsional)</label>
            <input id="referral" type="text" placeholder="s.id/..." />

            <div class="actions">
              <button id="generateBtn" class="btn">Generate Narasi AI ðŸš€</button>
              <button id="resetBtn" class="btn ghost">Reset</button>
            </div>

          </div>

          <!-- RIGHT: OUTPUT PANEL -->
          <div>
            <div class="results-wrap">
              <div class="out-title">Hasil</div>

              <div id="results">
                <div class="placeholder">
                  Klik "Generate Narasi AI" untuk melihat hasil (3 caption & 4 komentar).
                </div>
              </div>

              <!-- result actions -->
              <div class="result-actions">
                <button id="copyAllComments" class="copy-btn small">Copy Semua Komentar</button>
                <button id="copyAllCaptions" class="copy-btn small">Copy Semua Caption</button>
                <button id="downloadJSON" class="copy-btn small">Download JSON</button>
              </div>

            </div>
          </div>
        </div>


      </div>
    </div>
  </div>


<!-- ================= SCRIPTS ================= -->
<script>
  const preset = document.getElementById('preset');
  const nameMain = document.getElementById('name');
  const nameManual = document.getElementById('nameManual');
  const imageInput = document.getElementById('imageInput');
  const preview = document.getElementById('preview');

  const resultsDiv = document.getElementById('results');
  const generateBtn = document.getElementById('generateBtn');
  const resetBtn = document.getElementById('resetBtn');

  const copyAllCommentsBtn = document.getElementById('copyAllComments');
  const copyAllCaptionsBtn = document.getElementById('copyAllCaptions');
  const downloadJSONBtn = document.getElementById('downloadJSON');

  let currentImageBase64 = null;

  // Preview
  imageInput.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if (!f) { preview.innerHTML = ""; currentImageBase64=null; return; }
    const reader = new FileReader();
    reader.onload = () => {
      const src = reader.result;
      currentImageBase64 = src.split(',')[1];
      preview.innerHTML = `<img src="${src}" />`;
    };
    reader.readAsDataURL(f);
  });

  // Preset sync
  preset.addEventListener('change', () => {
    nameManual.value = preset.value;
    nameMain.value = preset.value;
  });

  nameManual.addEventListener('input', () => {
    nameMain.value = nameManual.value;
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    preset.value = "";
    nameMain.value = "";
    nameManual.value = "";
    document.getElementById('type').value = "Campuran";
    document.getElementById('tone').value = "Inspiratif";
    document.getElementById('referral').value = "";
    preview.innerHTML = "";
    imageInput.value = "";
    resultsDiv.innerHTML = `<div class="placeholder">Klik "Generate Narasi AI" untuk melihat hasil.</div>`;
  });

  // Generate
  generateBtn.addEventListener('click', async () => {
    const payload = {
      name: nameMain.value.trim(),
      preset: preset.value,
      nameManual: nameManual.value.trim(),
      type: document.getElementById('type').value,
      tone: document.getElementById('tone').value,
      referral: document.getElementById('referral').value.trim(),
      imageBase64: currentImageBase64,
      ctaStyle: "B"
    };

    generateBtn.disabled = true;
    generateBtn.innerText = "Memproses...";

    try {
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      renderResults(data);

    } catch (err) {
      alert("Gagal generate: " + err.message);
      console.error(err);

    } finally {
      generateBtn.disabled = false;
      generateBtn.innerText = "Generate Narasi AI ðŸš€";
    }
  });

  // Render Result
  function renderResults(data) {
    resultsDiv.innerHTML = "";

    // ANALYSIS BLOCK
    const ana = document.createElement("div");
    ana.className = "variant";
    ana.innerHTML = `
      <strong style="color:#9aa4b3">Analisis Singkat</strong>
      <pre>${escape(JSON.stringify(data.analysis, null, 2))}</pre>
    `;
    resultsDiv.appendChild(ana);

    // COMMENTS BLOCK
    const comWrap = document.createElement("div");
    comWrap.className = "variant";
    comWrap.innerHTML = `<strong style="color:#9aa4b3">Komentar Meta-Friendly</strong>`;

    data.commentVariants.forEach((txt, i) => {
      const v = document.createElement("div");
      v.style.marginTop = "12px";
      v.innerHTML = `
        <div style="font-size:12px; color:#9aa4b3">Varian ${i+1}</div>
        <pre>${escape(txt)}</pre>
        <button class="copy-btn small" onclick="copyText(\`${escapeJS(txt)}\`)">Copy</button>
      `;
      comWrap.appendChild(v);
    });

    resultsDiv.appendChild(comWrap);

    // CAPTIONS BLOCK
    const capWrap = document.createElement("div");
    capWrap.className = "variant";
    capWrap.innerHTML = `<strong style="color:#9aa4b3">Caption (HOOKâ€“MASALAHâ€“SOLUSIâ€“CTAâ€“TAG)</strong>`;

    data.captionVariants.forEach((txt, i) => {
      const v = document.createElement("div");
      v.style.marginTop = "12px";
      v.innerHTML = `
        <div style="font-size:12px; color:#9aa4b3">Varian ${i+1}</div>
        <pre>${escape(txt)}</pre>
        <button class="copy-btn small" onclick="copyText(\`${escapeJS(txt)}\`)">Copy</button>
      `;
      capWrap.appendChild(v);
    });

    resultsDiv.appendChild(capWrap);
  }

  function escape(str) {
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function escapeJS(str) {
    return String(str).replace(/`/g,"\\`");
  }

  function copyText(t) {
    navigator.clipboard.writeText(t).then(() => {
      alert("Teks disalin!");
    });
  }

  // Copy all
  copyAllCommentsBtn.onclick = () => {
    navigator.clipboard.writeText(
      document.querySelectorAll(".variant pre")[1].innerText
    ).then(() => alert("Semua komentar disalin!"));
  };

  copyAllCaptionsBtn.onclick = () => {
    navigator.clipboard.writeText(
      document.querySelectorAll(".variant pre")[2].innerText
    ).then(() => alert("Semua caption disalin!"));
  };

  downloadJSONBtn.onclick = () => {
    const text = document.querySelector(".variant pre").innerText;
    const blob = new Blob([text],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "npa-ai-output.json";
    a.click();
  };

</script>

</body>
</html>
